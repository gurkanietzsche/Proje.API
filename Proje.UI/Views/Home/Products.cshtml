@section Scripts {
<script>
    $(document).ready(function(){
        var apiBaseUrl = "@ViewBag.ApiBaseURL";
        var productId = 0;
        if(localStorage.getItem("token") == "" || localStorage.getItem("token") == null){
            location.href = "/Login";
            return false;
        }
        var token = localStorage.getItem("token");
        var userRoles = localStorage.getItem("userRoles") ? localStorage.getItem("userRoles").split(", ") : [];

        var catId = "@ViewBag.CatId";
        GetCategoryById();
        GetProductList();
        GetCategoryList();
        $("#btnCancel").hide();
        $("#btnEdit").hide();
        $("#btnDelete").hide();

        function GetProductList(){
            var url = catId && catId != "0"
                ? apiBaseUrl + "/Product/Category/" + catId
                : apiBaseUrl + "/Product";

            $.ajax({
                url: url,
                type: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function (d) {
                    ProductToTable(d);
                },
                error: function (d) {
                    if(d.status === 401) {
                        localStorage.removeItem("token");
                        document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                        location.href = "/Login";
                    } else {
                        showNotification("Ürünler yüklenirken bir hata oluştu", "error");
                    }
                },
            });
        }

        function GetCategoryById(){
            if (!catId || catId == "0") {
                $("#catName").html("Tüm Ürünler");
                return;
            }

            $.ajax({
                url: apiBaseUrl + "/Category/" + catId,
                type: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function (d) {
                    $("#catName").html(d.name);
                    $("#cbCategoryId").val(d.id);
                },
                error: function (d) {
                    showNotification("Kategori bilgisi yüklenirken bir hata oluştu", "error");
                },
            });
        }

        function GetCategoryList(){
            $.ajax({
                url: apiBaseUrl + "/Category/",
                type: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function (d) {
                    $("#cbCategoryId").empty();
                    var options = "<option value=''>Seçiniz</option>";
                    $.each(d, function(i, item){
                        if (item.id == catId){
                            options += '<option value="' + item.id + '" selected>' + item.name + '</option>';
                        } else {
                            options += '<option value="' + item.id + '">' + item.name + '</option>';
                        }
                    });
                    $("#cbCategoryId").append(options);
                },
                error: function (d) {
                    showNotification("Kategori listesi yüklenirken bir hata oluştu", "error");
                },
            });
        }

        // Ürünleri tabloya doldur
        function ProductToTable(data){
            // Mevcut kod aynı kalabilir
        }

        $("#btnSave").click(function(){
            if($("#txtName").val() == "" || $("#txtName").val() == null){
                showNotification("Ürün Adı Giriniz!", "error");
                return false;
            }

            if($("#cbCategoryId").val() == "" || $("#cbCategoryId").val() == null){
                showNotification("Kategori Seçiniz!", "error");
                return false;
            }

            var name = $("#txtName").val();
            var price = $("#txtPrice").val();
            var stock = $("#txtStock").val();
            var description = $("#txtDescription").val();
            var categoryId = $("#cbCategoryId").val();
            var imageUrl = $("#txtImageUrl").val() || "/images/no-image.png";
            var isActive = $("#cbIsActive").is(":checked");

            var product = {
                name: name,
                price: price,
                stock: stock,
                description: description,
                categoryId: categoryId,
                imageUrl: imageUrl,
                isActive: isActive
            };

            $.ajax({
                url: apiBaseUrl + "/Product",
                type: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                },
                data: JSON.stringify(product),
                contentType: "application/json",
                success: function (d) {
                    if (d.status){
                        showNotification("Ürün başarıyla eklendi", "success");
                        GetProductList();
                        // Formu temizle
                        $("#txtName").val("");
                        $("#txtPrice").val("");
                        $("#txtStock").val("");
                        $("#txtDescription").val("");
                        $("#txtImageUrl").val("");
                        $("#cbIsActive").prop("checked", true);
                    } else {
                        showNotification(d.message, "error");
                    }
                },
                error: function (d) {
                    showNotification("Ürün eklenirken bir hata oluştu", "error");
                },
            });
        });

        $(document).on("click", ".btnEdit", function(){
            var id = $(this).attr("data-id");
            $.ajax({
                url: apiBaseUrl + "/Product/" + id,
                type: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                contentType: "application/json",
                success: function (d) {
                    $("#btnSave").hide();
                    $("#btnCancel").show();
                    $("#btnEdit").show();
                    $("#btnDelete").show();
                    $("#txtId").val(d.id);
                    $("#txtName").val(d.name);
                    $("#txtPrice").val(d.price);
                    $("#txtStock").val(d.stock);
                    $("#txtDescription").val(d.description);
                    $("#txtImageUrl").val(d.imageUrl);
                    $("#cbCategoryId").val(d.categoryId);
                    $("#cbIsActive").prop("checked", d.isActive);
                },
                error: function (d) {
                    showNotification("Ürün bilgileri yüklenirken bir hata oluştu", "error");
                },
            });
        });

        $("#btnCancel").click(function(){
            $("#btnCancel").hide();
            $("#btnEdit").hide();
            $("#btnDelete").hide();
            $("#btnSave").show();
            $("#txtName").val("");
            $("#txtPrice").val("");
            $("#txtStock").val("");
            $("#txtDescription").val("");
            $("#txtImageUrl").val("");
            $("#cbIsActive").prop("checked", true);
            $("#txtId").val("");
        });

        $("#btnEdit").click(function(){
            if($("#txtName").val() == "" || $("#txtName").val() == null){
                showNotification("Ürün Adı Giriniz!", "error");
                return false;
            }

            if($("#cbCategoryId").val() == "" || $("#cbCategoryId").val() == null){
                showNotification("Kategori Seçiniz!", "error");
                return false;
            }

            var id = $("#txtId").val();
            var name = $("#txtName").val();
            var price = $("#txtPrice").val();
            var stock = $("#txtStock").val();
            var description = $("#txtDescription").val();
            var categoryId = $("#cbCategoryId").val();
            var imageUrl = $("#txtImageUrl").val() || "/images/no-image.png";
            var isActive = $("#cbIsActive").is(":checked");

            var product = {
                id: id,
                name: name,
                price: price,
                stock: stock,
                description: description,
                categoryId: categoryId,
                imageUrl: imageUrl,
                isActive: isActive
            };

            $.ajax({
                url: apiBaseUrl + "/Product/" + id,
                type: "PUT",
                headers: {
                    "Authorization": "Bearer " + token
                },
                data: JSON.stringify(product),
                contentType: "application/json",
                success: function (d) {
                    if (d.status){
                        showNotification("Ürün başarıyla güncellendi", "success");
                        GetProductList();
                        $("#btnCancel").click();
                    } else {
                        showNotification(d.message, "error");
                    }
                },
                error: function (d) {
                    showNotification("Ürün güncellenirken bir hata oluştu", "error");
                },
            });
        });

        $("#btnDelete").click(function(){
            var id = $("#txtId").val();
            if (confirm("Bu ürünü silmek istediğinizden emin misiniz?")) {
                $.ajax({
                    url: apiBaseUrl + "/Product/" + id,
                    type: "DELETE",
                    headers: {
                        "Authorization": "Bearer " + token
                    },
                    contentType: "application/json",
                    success: function (d) {
                        if (d.status){
                            showNotification("Ürün başarıyla silindi", "success");
                            GetProductList();
                            $("#btnCancel").click();
                        } else {
                            showNotification(d.message, "error");
                        }
                    },
                    error: function (d) {
                        showNotification("Ürün silinirken bir hata oluştu", "error");
                    },
                });
            }
        });

        $(document).on("click", ".btnImg", function(){
            var src = $(this).attr("src");
            productId = $(this).attr("data-id");
            $("#productPicture").attr("src", src);
            $("#productModal").modal("show");
        });

        $("#fileInput").change(function () {
            var files = $(this).prop('files');
            if (files && files[0]) {
                var reader = new FileReader();
                reader.onload = function (e) {
                    $('#productPicture').attr('src', e.target.result);
                    var fileData = e.target.result;

                    // Dosya uzantısını belirle
                    var fileExtension = files[0].name.split('.').pop().toLowerCase();
                    ProductPicUpdate(fileData, fileExtension);
                };
                reader.readAsDataURL(files[0]);
            }
        });

        function ProductPicUpdate(picData, picExt) {
            var upload = {
                productId: productId,
                picData: picData,
                picExt: "." + picExt
            };

            $.ajax({
                url: apiBaseUrl + "/Product/Upload",
                type: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                },
                data: JSON.stringify(upload),
                contentType: "application/json",
                success: function (data) {
                    if (data.status) {
                        showNotification("Ürün fotoğrafı başarıyla güncellendi", "success");
                    } else {
                        showNotification(data.message, "error");
                    }
                },
                error: function () {
                    showNotification("Resim yüklenirken bir hata oluştu", "error");
                }
            });
        }

        $("#btnUploadClose").click(function(){
            $("#productModal").modal("hide");
            GetProductList();
        });
    });
</script>
}