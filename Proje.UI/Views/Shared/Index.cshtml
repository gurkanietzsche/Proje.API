@
{

    ViewData
[
"Title"
]
 
=
 
"Home Page"
;

}


<div class="text-center">
    <h1 class="display-4">Ürün Listesi</h1>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="card mb-4">
            <div class="card-header">
                <h5>Filtreler</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="categoryFilter" class="form-label">Kategori</label>
                    <select id="categoryFilter" class="form-select">
                        <option value="">Tümü</option>
                        
@foreach
 
(
var
 category 
in
 ViewBag
.
Categories 
??
 
new
 
List
<
Category
>
(
)
)

                        
{

                            
<
option
 
value
=
"
@category.Id
"
>
@
category
.
Name
</
option
>

                        
}

                    </select>
                </div>
                <div class="mb-3">
                    <label for="minPrice" class="form-label">Min Fiyat</label>
                    <input type="number" id="minPrice" class="form-control" min="0" step="0.01">
                </div>
                <div class="mb-3">
                    <label for="maxPrice" class="form-label">Max Fiyat</label>
                    <input type="number" id="maxPrice" class="form-control" min="0" step="0.01">
                </div>
                <button id="btnFilter" class="btn btn-primary">Filtrele</button>
            </div>
        </div>
    </div>

    <div class="col-md-9">
        <div class="mb-3">
            <div class="input-group">
                <input type="text" id="searchInput" class="form-control" placeholder="Ürün ara...">
                <button id="btnSearch" class="btn btn-outline-secondary" type="button">Ara</button>
            </div>
        </div>

        <div id="productList" class="row">
            
@if
 
(
Model 
!=
 
null
 
&&
 Model
.
Any
(
)
)

            
{

                @
foreach
 
(
var
 product 
in
 Model
)

                
{

                    
<
div
 
class
=
"
col-md-4 mb-4
"
>

                        
<
div
 
class
=
"
card h-100
"
>

                            
<
img
 src
=
"@(string.IsNullOrEmpty(product.ImageUrl) ? "
/
img
/
no
-
image
.
jpg
" : product.ImageUrl)"
 
                                 
class
=
"card-img-top"
 alt
=
"@product.Name"
 style
=
"height: 200px; object-fit: cover;"
>

                            
<
div
 
class
=
"
card-body
"
>

                                
<
h5
 
class
=
"
card-title
"
>
@
product
.
Name
</
h5
>

                                
<
p
 
class
=
"
card-text
"
>
@
(
product
.
Description
.
Length 
>
 
100
 
?
 product
.
Description
.
Substring
(
0
,
 
100
)
 
+
 
"..."
 
:
 product
.
Description
)
</
p
>

                                
<
p
 
class
=
"
card-text
"
>
<
small
 
class
=
"
text-muted
"
>
Kategori: 
@
product
.
Category
.
Name
</
small
>
</
p
>

                                
<
h6
 
class
=
"
card-subtitle mb-2 text-primary
"
>
@
product
.
Price
.
ToString
(
"C"
)
</
h6
>

                                
<
a
 
href
=
"
@Url.Action(
"
Detail",
 
"Home",
 
new
 
{
 
id
 
=
 product.Id
 
})"
 
class
=
"
btn btn-outline-primary
"
>
Detay
</
a
>

                                
<
button
 
class
=
"
btn btn-success add-to-cart
"
 
data-product-id
=
"
@product.Id
"
>
Sepete Ekle
</
button
>

                            
</
div
>

                        
<
/
div
>

                    
<
/
div
>

                
}

            
}

            
else

            
{

                
<
div
 
class
=
"
col-12
"
>

                    
<
div
 
class
=
"
alert alert-info
"
>

                        Ürün bulunamadı.
                    
</
div
>

                
</
div
>

            
}

        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Ürün ara
            $("#btnSearch").click(function() {
                var query = $("#searchInput").val();
                if (query.length > 0) {
                    $.ajax({
                        url: '@Url.Action("SearchProducts", "Home")',
                        type: 'GET',
                        data: { query: query },
                        success: function(response) {
                            if (response.success) {
                                updateProductList(response.products);
                            } else {
                                alert(response.message);
                            }
                        },
                        error: function() {
                            alert("İşlem sırasında bir hata oluştu.");
                        }
                    });
                }
            });

            // Ürün filtrele
            $("#btnFilter").click(function() {
                var categoryId = $("#categoryFilter").val();
                var minPrice = $("#minPrice").val();
                var maxPrice = $("#maxPrice").val();

                $.ajax({
                    url: '@Url.Action("FilterProducts", "Home")',
                    type: 'GET',
                    data: { 
                        categoryId: categoryId ? categoryId : null,
                        minPrice: minPrice ? minPrice : null,
                        maxPrice: maxPrice ? maxPrice : null
                    },
                    success: function(response) {
                        if (response.success) {
                            updateProductList(response.products);
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function() {
                        alert("İşlem sırasında bir hata oluştu.");
                    }
                });
            });

            // Sepete ekle
            $(document).on("click", ".add-to-cart", function() {
                var productId = $(this).data("product-id");
                
                $.ajax({
                    url: '@Url.Action("AddToCart", "Home")',
                    type: 'POST',
                    data: { productId: productId, quantity: 1 },
                    success: function(response) {
                        if (response.success) {
                            alert(response.message);
                            // Sepet sayacını güncelle
                            $("#cartItemCount").text(response.cartItemCount);
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function() {
                        alert("İşlem sırasında bir hata oluştu.");
                    }
                });
            });

            // Ürün listesini güncelleme fonksiyonu
            function updateProductList(products) {
                var productListHtml = '';
                
                if (products.length > 0) {
                    $.each(products, function(index, product) {
                        productListHtml += '<div class="col-md-4 mb-4">';
                        productListHtml += '<div class="card h-100">';
                        productListHtml += '<img src="' + (product.imageUrl || '/img/no-image.jpg') + '" class="card-img-top" alt="' + product.name + '" style="height: 200px; object-fit: cover;">';
                        productListHtml += '<div class="card-body">';
                        productListHtml += '<h5 class="card-title">' + product.name + '</h5>';
                        
                        var description = product.description;
                        if (description.length > 100) {
                            description = description.substring(0, 100) + '...';
                        }
                        
                        productListHtml += '<p class="card-text">' + description + '</p>';
                        productListHtml += '<p class="card-text"><small class="text-muted">Kategori: ' + product.category.name + '</small></p>';
                        productListHtml += '<h6 class="card-subtitle mb-2 text-primary">' + product.price.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' }) + '</h6>';
                        productListHtml += '<a href="/Home/Detail/' + product.id + '" class="btn btn-outline-primary">Detay</a>';
                        productListHtml += '<button class="btn btn-success add-to-cart" data-product-id="' + product.id + '">Sepete Ekle</button>';
                        productListHtml += '</div></div></div>';
                    });
                } else {
                    productListHtml = '<div class="col-12"><div class="alert alert-info">Ürün bulunamadı.</div></div>';
                }
                
                $('#productList').html(productListHtml);
            }
        });
    </script>
}