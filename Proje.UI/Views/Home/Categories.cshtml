@{
    ViewData["Title"] = "Kategoriler";
}

<div class="row">
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Kategori Listesi</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="tbCategories" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Kategori Adı</th>
                                <th>Açıklama</th>
                                <th>Üst Kategori</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Kategoriler buraya gelecek -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Kategori Ekle/Düzenle</h6>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <input type="hidden" id="txtId" />
                    <label for="txtName">Kategori Adı</label>
                    <input type="text" class="form-control" id="txtName" placeholder="Kategori adı giriniz">
                </div>
                <div class="form-group">
                    <label for="txtDescription">Açıklama</label>
                    <textarea class="form-control" id="txtDescription" rows="3" placeholder="Açıklama giriniz"></textarea>
                </div>
                <div class="form-group">
                    <label for="cbParentCategory">Üst Kategori</label>
                    <select class="form-control" id="cbParentCategory">
                        <option value="">Ana Kategori</option>
                    </select>
                </div>
                <div class="form-group form-check">
                    <input type="checkbox" class="form-check-input" id="cbIsActive" checked>
                    <label class="form-check-label" for="cbIsActive">Aktif</label>
                </div>
                <button type="button" id="btnSave" class="btn btn-success btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-check"></i>
                    </span>
                    <span class="text">Kaydet</span>
                </button>
                <button type="button" id="btnEdit" class="btn btn-warning btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-edit"></i>
                    </span>
                    <span class="text">Güncelle</span>
                </button>
                <button type="button" id="btnDelete" class="btn btn-danger btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-trash"></i>
                    </span>
                    <span class="text">Sil</span>
                </button>
                <button type="button" id="btnCancel" class="btn btn-secondary btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-times"></i>
                    </span>
                    <span class="text">Vazgeç</span>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function(){
            var apiBaseUrl = "@ViewBag.ApiBaseURL";
            if(localStorage.getItem("token") == "" || localStorage.getItem("token") == null){
                location.href = "/Login";
                return false;
            }
            var token = localStorage.getItem("token");
            var userRoles = localStorage.getItem("userRoles") ? localStorage.getItem("userRoles").split(", ") : [];

            GetCategoryList();
            LoadParentCategories();
            $("#btnCancel").hide();
            $("#btnEdit").hide();
            $("#btnDelete").hide();

            function GetCategoryList(){
                $.ajax({
                    url: apiBaseUrl + "/Category",
                    type: "GET",
                    headers: {
                        "Authorization": "Bearer " + token
                    },
                    success: function (d) {
                        CategoryToTable(d);
                    },
                    error: function (d) {
                        if(d.status === 401) {
                            localStorage.removeItem("token");
                            document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                            location.href = "/Login";
                        } else {
                            showNotification("Kategoriler yüklenirken bir hata oluştu", "error");
                        }
                    },
                });
            }

            function LoadParentCategories() {
                $.ajax({
                    url: apiBaseUrl + "/Category",
                    type: "GET",
                    headers: {
                        "Authorization": "Bearer " + token
                    },
                    success: function (d) {
                        $("#cbParentCategory").empty();
                        $("#cbParentCategory").append('<option value="">Ana Kategori</option>');

                        $.each(d, function(i, item) {
                            $("#cbParentCategory").append('<option value="' + item.id + '">' + item.name + '</option>');
                        });
                    },
                    error: function (d) {
                        showNotification("Üst kategoriler yüklenirken bir hata oluştu", "error");
                    },
                });
            }

            // Kategorileri tabloya doldur
            function CategoryToTable(data){
                $("#tbCategories tbody").empty();
                var row = "";
                $.each(data, function(i, item){
                    row += "<tr>";
                    row += "<td>" + item.id + "</td>";
                    row += "<td>" + item.name + "</td>";
                    row += "<td>" + item.description + "</td>";
                    row += "<td>" + (item.parentCategoryName || "Ana Kategori") + "</td>";
                    row += "<td>" + (item.isActive ? '<span class="badge bg-success text-white">Aktif</span>' : '<span class="badge bg-danger text-white">Pasif</span>') + "</td>";
                    row += '<td><button class="btn btn-warning btn-sm btnEdit" data-id="' + item.id + '"><i class="fas fa-edit"></i></button></td>';
                    row += "</tr>";
                });
                $("#tbCategories tbody").append(row);
            }

                $("#btnSave").click(function(){
            if($("#txtName").val() == "" || $("#txtName").val() == null){
                showNotification("Kategori Adı Giriniz!", "error");
                return false;
            }

            var name = $("#txtName").val();
            var description = $("#txtDescription").val();
            var parentCategoryId = $("#cbParentCategory").val() || null;
            var isActive = $("#cbIsActive").is(":checked");

            var category = {
                name: name,
                description: description,
                parentCategoryId: parentCategoryId ? parseInt(parentCategoryId) : null,
                isActive: isActive
            };

            // Debugging
            console.log("Gönderilen kategori:", category);

            $.ajax({
                url: apiBaseUrl + "/Category",
                type: "POST",
                headers: {
                    "Authorization": "Bearer " + token,
                    "Content-Type": "application/json"
                },
                data: JSON.stringify(category),
                contentType: "application/json",
                success: function (d) {
                    console.log("Başarılı cevap:", d);
                    if (d.status){
                        showNotification("Kategori başarıyla eklendi", "success");
                        GetCategoryList();
                        LoadParentCategories();
                        // Formu temizle
                        $("#txtName").val("");
                        $("#txtDescription").val("");
                        $("#cbParentCategory").val("");
                        $("#cbIsActive").prop("checked", true);
                    } else {
                        showNotification(d.message || "Kategori eklenirken bir hata oluştu", "error");
                    }
                },
                error: function (d) {
                    console.log("Hata:", d);
                    showNotification("Kategori eklenirken bir hata oluştu: " + (d.responseJSON ? d.responseJSON.message : d.statusText), "error");
                }
            });
        });

            $(document).on("click", ".btnEdit", function(){
                var id = $(this).attr("data-id");
                $.ajax({
                    url: apiBaseUrl + "/Category/" + id,
                    type: "GET",
                    headers: {
                        "Authorization": "Bearer " + token
                    },
                    contentType: "application/json",
                    success: function (d) {
                        $("#btnSave").hide();
                        $("#btnCancel").show();
                        $("#btnEdit").show();
                        $("#btnDelete").show();
                        $("#txtId").val(d.id);
                        $("#txtName").val(d.name);
                        $("#txtDescription").val(d.description);
                        $("#cbParentCategory").val(d.parentCategoryId || "");
                        $("#cbIsActive").prop("checked", d.isActive);
                    },
                    error: function (d) {
                        showNotification("Kategori bilgileri yüklenirken bir hata oluştu", "error");
                    },
                });
            });

            $("#btnCancel").click(function(){
                $("#btnCancel").hide();
                $("#btnEdit").hide();
                $("#btnDelete").hide();
                $("#btnSave").show();
                $("#txtName").val("");
                $("#txtDescription").val("");
                $("#cbParentCategory").val("");
                $("#txtId").val("");
                $("#cbIsActive").prop("checked", true);
            });

            $("#btnEdit").click(function(){
                if($("#txtName").val() == "" || $("#txtName").val() == null){
                    showNotification("Kategori Adı Giriniz!", "error");
                    return false;
                }
                var id = $("#txtId").val();
                var name = $("#txtName").val();
                var description = $("#txtDescription").val();
                var parentCategoryId = $("#cbParentCategory").val();
                var isActive = $("#cbIsActive").is(":checked");
                var category = {
                    id: id,
                    name: name,
                    description: description,
                    parentCategoryId: parentCategoryId || null,
                    isActive: isActive
                };

                $.ajax({
                    url: apiBaseUrl + "/Category/" + id,
                    type: "PUT",
                    headers: {
                        "Authorization": "Bearer " + token
                    },
                    data: JSON.stringify(category),
                    contentType: "application/json",
                    success: function (d) {
                        if (d.status){
                            showNotification("Kategori başarıyla güncellendi", "success");
                            GetCategoryList();
                            LoadParentCategories();
                            $("#btnCancel").click();
                        } else {
                            showNotification(d.message, "error");
                        }
                    },
                    error: function (d) {
                        showNotification("Kategori güncellenirken bir hata oluştu", "error");
                    },
                });
            });

            $("#btnDelete").click(function(){
                var id = $("#txtId").val();
                if (confirm("Bu kategoriyi silmek istediğinizden emin misiniz?")) {
                    $.ajax({
                        url: apiBaseUrl + "/Category/" + id,
                        type: "DELETE",
                        headers: {
                            "Authorization": "Bearer " + token
                        },
                        contentType: "application/json",
                        success: function (d) {
                            if (d.status){
                                showNotification("Kategori başarıyla silindi", "success");
                                GetCategoryList();
                                LoadParentCategories();
                                $("#btnCancel").click();
                            } else {
                                showNotification(d.message, "error");
                            }
                        },
                        error: function (d) {
                            showNotification("Kategori silinirken bir hata oluştu", "error");
                        },
                    });
                }
            });
        });
    </script>
}