@{
    ViewData["Title"] = "Ürünler";
}

<div class="row">
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary">Ürün Listesi - <span id="catName"></span></h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-bordered" id="tbProducts" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Resim</th>
                                <th>Ürün Adı</th>
                                <th>Fiyat</th>
                                <th>Stok</th>
                                <th>Kategori</th>
                                <th>Durum</th>
                                <th>İşlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Ürünler buraya gelecek -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">Ürün Ekle/Düzenle</h6>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <input type="hidden" id="txtId" />
                    <label for="txtName">Ürün Adı</label>
                    <input type="text" class="form-control" id="txtName" placeholder="Ürün adı giriniz">
                </div>
                <div class="form-group">
                    <label for="txtDescription">Açıklama</label>
                    <textarea class="form-control" id="txtDescription" rows="3" placeholder="Açıklama giriniz"></textarea>
                </div>
                <div class="form-group">
                    <label for="txtPrice">Fiyat</label>
                    <input type="number" class="form-control" id="txtPrice" placeholder="Fiyat giriniz">
                </div>
                <div class="form-group">
                    <label for="txtStock">Stok</label>
                    <input type="number" class="form-control" id="txtStock" placeholder="Stok miktarı giriniz">
                </div>
                <div class="form-group">
                    <label for="txtImageUrl">Resim URL</label>
                    <input type="text" class="form-control" id="txtImageUrl" placeholder="Resim URL giriniz">
                </div>
                <div class="form-group">
                    <label for="cbCategoryId">Kategori</label>
                    <select class="form-control" id="cbCategoryId">
                        <option value="">Seçiniz</option>
                    </select>
                </div>
                <div class="form-group form-check">
                    <input type="checkbox" class="form-check-input" id="cbIsActive" checked>
                    <label class="form-check-label" for="cbIsActive">Aktif</label>
                </div>
                <button type="button" id="btnSave" class="btn btn-success btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-check"></i>
                    </span>
                    <span class="text">Kaydet</span>
                </button>
                <button type="button" id="btnEdit" class="btn btn-warning btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-edit"></i>
                    </span>
                    <span class="text">Güncelle</span>
                </button>
                <button type="button" id="btnDelete" class="btn btn-danger btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-trash"></i>
                    </span>
                    <span class="text">Sil</span>
                </button>
                <button type="button" id="btnCancel" class="btn btn-secondary btn-icon-split">
                    <span class="icon text-white-50">
                        <i class="fas fa-times"></i>
                    </span>
                    <span class="text">Vazgeç</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Resim Yükleme Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Ürün Resmi</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="productPicture" class="img-fluid mb-3" style="max-height: 300px;">
                <input type="file" id="fileInput" class="form-control">
            </div>
            <div class="modal-footer">
                <button type="button" id="btnUploadClose" class="btn btn-secondary">Kapat</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    $(document).ready(function(){
        var apiBaseUrl = "@ViewBag.ApiBaseURL";
        var productId = 0;
        if(localStorage.getItem("token") == "" || localStorage.getItem("token") == null){
            location.href = "/Login";
            return false;
        }
        var token = localStorage.getItem("token");
        var userRoles = localStorage.getItem("userRoles") ? localStorage.getItem("userRoles").split(", ") : [];

        var catId = "@ViewBag.CatId";
        GetCategoryById();
        GetProductList();
        GetCategoryList();
        $("#btnCancel").hide();
        $("#btnEdit").hide();
        $("#btnDelete").hide();

        function GetProductList(){
            var url = catId && catId != "0"
                ? apiBaseUrl + "/Product/Category/" + catId
                : apiBaseUrl + "/Product";

            $.ajax({
                url: url,
                type: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function (d) {
                    ProductToTable(d);
                },
                error: function (d) {
                    if(d.status === 401) {
                        localStorage.removeItem("token");
                        document.cookie = "token=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
                        location.href = "/Login";
                    } else {
                        showNotification("Ürünler yüklenirken bir hata oluştu", "error");
                    }
                },
            });
        }

        function GetCategoryById(){
            if (!catId || catId == "0") {
                $("#catName").html("Tüm Ürünler");
                return;
            }

            $.ajax({
                url: apiBaseUrl + "/Category/" + catId,
                type: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function (d) {
                    $("#catName").html(d.name);
                    $("#cbCategoryId").val(d.id);
                },
                error: function (d) {
                    showNotification("Kategori bilgisi yüklenirken bir hata oluştu", "error");
                },
            });
        }

        function GetCategoryList(){
            $.ajax({
                url: apiBaseUrl + "/Category/",
                type: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function (d) {
                    $("#cbCategoryId").empty();
                    var options = "<option value=''>Seçiniz</option>";
                    $.each(d, function(i, item){
                        if (item.id == catId){
                            options += '<option value="' + item.id + '" selected>' + item.name + '</option>';
                        } else {
                            options += '<option value="' + item.id + '">' + item.name + '</option>';
                        }
                    });
                    $("#cbCategoryId").append(options);
                },
                error: function (d) {
                    showNotification("Kategori listesi yüklenirken bir hata oluştu", "error");
                },
            });
        }

        // Ürünleri tabloya doldur
        function ProductToTable(data){
            $("#tbProducts tbody").empty();
            var row = "";
            $.each(data, function(i, item){
                row += "<tr>";
                row += "<td>" + item.id + "</td>";
                row += '<td><img src="' + item.imageUrl + '" class="img-thumbnail btnImg" width="50" data-id="' + item.id + '" style="cursor:pointer;"></td>';
                row += "<td>" + item.name + "</td>";
                row += "<td>" + item.price + " ₺</td>";
                row += "<td>" + item.stock + "</td>";
                row += "<td>" + item.categoryName + "</td>";
                row += "<td>" + (item.isActive ? '<span class="badge bg-success text-white">Aktif</span>' : '<span class="badge bg-danger text-white">Pasif</span>') + "</td>";
                row += '<td><button class="btn btn-warning btn-sm btnEdit" data-id="' + item.id + '"><i class="fas fa-edit"></i></button></td>';
                row += "</tr>";
            });
            $("#tbProducts tbody").append(row);
        }

        $("#btnSave").click(function(){
            if($("#txtName").val() == "" || $("#txtName").val() == null){
                showNotification("Ürün Adı Giriniz!", "error");
                return false;
            }

            if($("#cbCategoryId").val() == "" || $("#cbCategoryId").val() == null){
                showNotification("Kategori Seçiniz!", "error");
                return false;
            }

            var name = $("#txtName").val();
            var price = $("#txtPrice").val();
            var stock = $("#txtStock").val();
            var description = $("#txtDescription").val();
            var categoryId = $("#cbCategoryId").val();
            var imageUrl = $("#txtImageUrl").val() || "/images/no-image.png";
            var isActive = $("#cbIsActive").is(":checked");

            var product = {
                name: name,
                price: price,
                stock: stock,
                description: description,
                categoryId: categoryId,
                imageUrl: imageUrl,
                isActive: isActive
            };

            $.ajax({
                url: apiBaseUrl + "/Product",
                type: "POST",
                headers: {
                    "Authorization": "Bearer " + token
                },
                data: JSON.stringify(product),
                contentType: "application/json",
                success: function (d) {
                    if (d.status){
                        showNotification("Ürün başarıyla eklendi", "success");
                        GetProductList();
                        // Formu temizle
                        $("#txtName").val("");
                        $("#txtPrice").val("");
                        $("#txtStock").val("");
                        $("#txtDescription").val("");
                        $("#txtImageUrl").val("");
                        $("#cbIsActive").prop("checked", true);
                    } else {
                        showNotification(d.message, "error");
                    }
                },
                error: function (d) {
                    showNotification("Ürün eklenirken bir hata oluştu", "error");
                },
            });
        });

        $(document).on("click", ".btnEdit", function(){
            var id = $(this).attr("data-id");
            $.ajax({
                url: apiBaseUrl + "/Product/" + id,
                type: "GET",
                headers: {
                    "Authorization": "Bearer " + token
                },
                contentType: "application/json",
                success: function (d) {
                    $("#btnSave").hide();
                    $("#btnCancel").show();
                    $("#btnEdit").show();
                    $("#btnDelete").show();
                    $("#txtId").val(d.id);
                    $("#txtName").val(d.name);
                    $("#txtPrice").val(d.price);
                    $("#txtStock").val(d.stock);
                    $("#txtDescription").val(d.description);
                    $("#txtImageUrl").val(d.imageUrl);
                    $("#cbCategoryId").val(d.categoryId);
                    $("#cbIsActive").prop("checked", d.isActive);
                },
                error: function (d) {
                    showNotification("Ürün bilgileri yüklenirken bir hata oluştu", "error");
                },
            });
        });

        $("#btnCancel").click(function(){
            $("#btnCancel").hide();
            $("#btnEdit").hide();
            $("#btnDelete").hide();
            $("#btnSave").show();
            $("#txtName").val("");
            $("#txtPrice").val("");
            $("#txtStock").val("");
            $("#txtDescription").val("");
            $("#txtImageUrl").val("");
            $("#cbIsActive").prop("checked", true);
            $("#txtId").val("");
        });

        $("#btnEdit").click(function(){
            if($("#txtName").val() == "" || $("#txtName").val() == null){
                showNotification("Ürün Adı Giriniz!", "error");
                return false;
            }

            if($("#cbCategoryId").val() == "" || $("#cbCategoryId").val() == null){
                showNotification("Kategori Seçiniz!", "error");
                return false;
            }

            var id = $("#txtId").val();
            var name = $("#txtName").val();
            var price = $("#txtPrice").val();
            var stock = $("#txtStock").val();
            var description = $("#txtDescription").val();
            var categoryId = $("#cbCategoryId").val();
            var imageUrl = $("#txtImageUrl").val() || "/images/no-image.png";
            var isActive = $("#cbIsActive").is(":checked");

            var product = {
                id: id,
                name: name,
                price: price,
                stock: stock,
                description: description,
                categoryId: categoryId,
                imageUrl: imageUrl,
                isActive: isActive
            };

            $.ajax({
                url: apiBaseUrl + "/Product/" + id,
                type: "PUT",
                headers: {
                    "Authorization": "Bearer " + token
                },
                data: JSON.stringify(product),
                contentType: "application/json",
                success: function (d) {
                    if (d.status){
                        showNotification("Ürün başarıyla güncellendi", "success");
                        GetProductList();
                        $("#btnCancel").click();
                    } else {
                        showNotification(d.message, "error");
                    }
                },
                error: function (d) {
                    showNotification("Ürün güncellenirken bir hata oluştu", "error");
                },
            });
        });

        $("#btnDelete").click(function(){
            var id = $("#txtId").val();
            if (confirm("Bu ürünü silmek istediğinizden emin misiniz?")) {
                $.ajax({
                    url: apiBaseUrl + "/Product/" + id,
                    type: "DELETE",
                    headers: {
                        "Authorization": "Bearer " + token
                    },
                    contentType: "application/json",
                    success: function (d) {
                        if (d.status){
                            showNotification("Ürün başarıyla silindi", "success");
                            GetProductList();
                            $("#btnCancel").click();
                        } else {
                            showNotification(d.message, "error");
                        }
                    },
                    error: function (d) {
                        showNotification("Ürün silinirken bir hata oluştu", "error");
                    },
                });
            }
        });

            $(document).on("click", ".btnImg", function(){
                var src = $(this).attr("src");
                productId = $(this).attr("data-id");
                $("#productPicture").attr("src", src);
                $("#productModal").modal("show");
            });

            $("#fileInput").change(function () {
                var files = $(this).prop('files');
                if (files && files[0]) {
                    var reader = new FileReader();
                    reader.onload = function (e) {
                        $('#productPicture').attr('src', e.target.result);
                        var fileData = e.target.result;

                        // Dosya uzantısını belirle
                        var fileExtension = files[0].name.split('.').pop().toLowerCase();
                        ProductPicUpdate(fileData, fileExtension);
                    };
                    reader.readAsDataURL(files[0]);
                }
            });

            function ProductPicUpdate(picData, picExt) {
                var upload = {
                    productId: productId,
                    picData: picData,
                    picExt: "." + picExt
                };

                $.ajax({
                    url: apiBaseUrl + "/Product/Upload",
                    type: "POST",
                    headers: {
                        "Authorization": "Bearer " + token
                    },
                    data: JSON.stringify(upload),
                    contentType: "application/json",
                    success: function (data) {
                        if (data.status) {
                            showNotification("Ürün fotoğrafı başarıyla güncellendi", "success");
                        } else {
                            showNotification(data.message, "error");
                        }
                    },
                    error: function () {
                        showNotification("Resim yüklenirken bir hata oluştu", "error");
                    }
                });
            }

            $("#btnUploadClose").click(function(){
                $("#productModal").modal("hide");
                GetProductList();
            });
        });
    </script>
}