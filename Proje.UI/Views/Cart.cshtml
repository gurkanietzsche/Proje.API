@
{

    ViewData
[
"Title"
]
 
=
 
"Sepetim"
;

}


<div class="container mt-4">
    <h1 class="mb-4">Sepetim</h1>
    
    <div id="cartContainer">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Ürün</th>
                        <th>Fiyat</th>
                        <th>Miktar</th>
                        <th>Ara Toplam</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="cartItems">
                    <!-- Sepet öğeleri JavaScript ile yüklenecek -->
                </tbody>
                <tfoot>
                    <tr>
                        <td colspan="3" class="text-end fw-bold">Toplam:</td>
                        <td colspan="2" id="cartTotal" class="fw-bold"></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <div class="d-flex justify-content-between mt-4">
            <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Alışverişe Devam Et
            </a>
            <button id="clearCart" class="btn btn-outline-danger">
                <i class="bi bi-trash"></i> Sepeti Temizle
            </button>
            <button id="checkout" class="btn btn-success">
                <i class="bi bi-check2-circle"></i> Siparişi Tamamla
            </button>
        </div>
        
        <div id="emptyCart" class="text-center my-5" style="display: none;">
            <div class="alert alert-info">
                <h4>Sepetiniz boş</h4>
                <p>Sepetinizde henüz ürün bulunmuyor.</p>
                <a href="@Url.Action("Index", "Home")" class="btn btn-primary mt-3">
                    <i class="bi bi-arrow-left"></i> Alışverişe Başla
                </a>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Sepeti yükle
            loadCart();
            
            // Sepeti yükleme fonksiyonu
            function loadCart() {
                var cart = getCart();
                
                if (!cart || cart.length === 0) {
                    $("#cartContainer table").hide();
                    $("#clearCart, #checkout").hide();
                    $("#emptyCart").show();
                    return;
                }
                
                $("#emptyCart").hide();
                $("#cartContainer table").show();
                $("#clearCart, #checkout").show();
                
                var cartItemsHtml = '';
                var total = 0;
                
                $.each(cart, function(index, item) {
                    var subtotal = item.quantity * item.unitPrice;
                    total += subtotal;
                    
                    cartItemsHtml += '<tr>';
                    cartItemsHtml += '<td>';
                    cartItemsHtml += '<div class="d-flex align-items-center">';
                    cartItemsHtml += '<img src="' + (item.imageUrl || '/img/no-image.jpg') + '" alt="' + item.productName + '" style="width: 50px; height: 50px; object-fit: cover;" class="me-3">';
                    cartItemsHtml += '<div>' + item.productName + '</div>';
                    cartItemsHtml += '</div>';
                    cartItemsHtml += '</td>';
                    cartItemsHtml += '<td>' + item.unitPrice.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' }) + '</td>';
                    cartItemsHtml += '<td>';
                    cartItemsHtml += '<div class="input-group" style="width: 120px;">';
                    cartItemsHtml += '<button type="button" class="btn btn-outline-secondary btn-sm decreaseQuantity" data-product-id="' + item.productId + '">-</button>';
                    cartItemsHtml += '<input type="number" class="form-control text-center itemQuantity" value="' + item.quantity + '" min="1" data-product-id="' + item.productId + '">';
                    cartItemsHtml += '<button type="button" class="btn btn-outline-secondary btn-sm increaseQuantity" data-product-id="' + item.productId + '">+</button>';
                    cartItemsHtml += '</div>';
                    cartItemsHtml += '</td>';
                    cartItemsHtml += '<td>' + subtotal.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' }) + '</td>';
                    cartItemsHtml += '<td>';
                    cartItemsHtml += '<button class="btn btn-sm btn-danger removeItem" data-product-id="' + item.productId + '"><i class="bi bi-trash"></i></button>';
                    cartItemsHtml += '</td>';
                    cartItemsHtml += '</tr>';
                });
                
                $("#cartItems").html(cartItemsHtml);
                $("#cartTotal").text(total.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' }));
            }
            
            // Session'dan sepeti al
            function getCart() {
                var cartJson = sessionStorage.getItem('cart');
                return cartJson ? JSON.parse(cartJson) : [];
            }
            
            // Miktar artırma
            $(document).on('click', '.increaseQuantity', function() {
                var productId = $(this).data('product-id');
                var input = $(this).siblings('.itemQuantity');
                var currentValue = parseInt(input.val());
                
                input.val(currentValue + 1);
                updateCartItemQuantity(productId, currentValue + 1);
            });
            
            // Miktar azaltma
            $(document).on('click', '.decreaseQuantity', function() {
                var productId = $(this).data('product-id');
                var input = $(this).siblings('.itemQuantity');
                var currentValue = parseInt(input.val());
                
                if (currentValue > 1) {
                    input.val(currentValue - 1);
                    updateCartItemQuantity(productId, currentValue - 1);
                }
            });
            
            // Miktar değiştiğinde
            $(document).on('change', '.itemQuantity', function() {
                var productId = $(this).data('product-id');
                var quantity = parseInt($(this).val());
                
                if (quantity < 1) {
                    $(this).val(1);
                    quantity = 1;
                }
                
                updateCartItemQuantity(productId, quantity);
            });
            
            // Sepetten ürün silme
            $(document).on('click', '.removeItem', function() {
                var productId = $(this).data('product-id');
                
                $.ajax({
                    url: '@Url.Action("RemoveFromCart", "Home")',
                    type: 'POST',
                    data: { productId: productId },
                    success: function(response) {
                        if (response.success) {
                            // Sepet sayacını güncelle
                            $("#cartItemCount").text(response.cartItemCount);
                            // Sepeti yeniden yükle
                            loadCart();
                        } else {
                            alert(response.message);
                        }
                    },
                    error: function() {
                        alert("İşlem sırasında bir hata oluştu.");
                    }
                });
            });
            
            // Sepeti temizle
            $("#clearCart").click(function() {
                if (confirm("Sepetinizi tamamen temizlemek istediğinize emin misiniz?")) {
                    sessionStorage.removeItem('cart');
                    loadCart();
                    // Sepet sayacını sıfırla
                    $("#cartItemCount").text("0");
                }
            });
            
            // Siparişi tamamla
            $("#checkout").click(function() {
                window.location.href = "@Url.Action("Checkout", "Home")";
            });
            
            // Sepet öğesi miktarını güncelle
            function updateCartItemQuantity(productId, quantity) {
                var cart = getCart();
                
                var item = cart.find(i => i.productId === productId);
                if (item) {
                    item.quantity = quantity;
                    sessionStorage.setItem('cart', JSON.stringify(cart));
                    
                    // Sepet sayacını güncelle
                    var totalItems = cart.reduce((total, item) => total + item.quantity, 0);
                    $("#cartItemCount").text(totalItems);
                    
                    // Sepeti yeniden yükle
                    loadCart();
                }
            }
        });
    </script>
}