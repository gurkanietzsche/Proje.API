@model IEnumerable<Proje.UI.Models.DTOs.ProductDTO>
@{
    ViewData["Title"] = "Ürünler";
    var categoryName = ViewBag.CategoryName;
    var categories = ViewBag.Categories as IEnumerable<Proje.UI.Models.DTOs.CategoryDTO>;
}

<div class="row mb-4">
    <div class="col-12">
        <h2>@(categoryName ?? "Tüm Ürünler")</h2>
        <hr />
    </div>
</div>

<div class="row">
    <!-- Kategoriler -->
    <div class="col-md-3">
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Kategoriler</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    <a href="@Url.Action("Index", "Product")" class="list-group-item list-group-item-action @(categoryName == null ? "active" : "")">
                        Tümü
                    </a>
                    @if (categories != null)
                    {
                        foreach (var category in categories)
                        {
                            <a href="@Url.Action("Index", "Product", new { categoryId = category.Id })"
                               class="list-group-item list-group-item-action @(categoryName == category.Name ? "active" : "")">
                                @category.Name
                            </a>
                        }
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Ürünler -->
    <div class="col-md-9">
        <div class="row">
            @if (Model != null && Model.Any())
            {
                foreach (var product in Model)
                {
                    <div class="col-md-4 mb-4">
                        <div class="card h-100">
                            <img class="card-img-top" src="@product.ImageUrl" alt="@product.Name">
                            <div class="card-body">
                                <h5 class="card-title">@product.Name</h5>
                                <p class="card-text">@(product.Description.Length > 80 ? product.Description.Substring(0, 77) + "..." : product.Description)</p>
                                <p class="card-text text-success font-weight-bold">@product.Price.ToString("C2")</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between">
                                <a href="@Url.Action("Details", "Product", new { id = product.Id })" class="btn btn-primary btn-sm">Detaylar</a>
                                <button class="btn btn-success btn-sm add-to-cart" data-id="@product.Id">Sepete Ekle</button>
                            </div>
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="col-12">
                    <div class="alert alert-info">
                        Bu kategoride henüz ürün bulunmamaktadır.
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            $('.add-to-cart').on('click', function() {
                var productId = $(this).data('id');

                $.ajax({
                    url: '/Cart/AddToCart',
                    type: 'POST',
                    data: { productId: productId, quantity: 1 },
                    success: function(response) {
                        if (response.success) {
                            alert('Ürün sepete eklendi!');
                        } else {
                            alert('Ürün sepete eklenirken bir hata oluştu: ' + response.message);
                        }
                    },
                    error: function(xhr, status, error) {
                        if (xhr.status === 401) {
                            // Kullanıcı giriş yapmamış
                            if (confirm('Bu işlemi gerçekleştirmek için giriş yapmanız gerekmektedir. Giriş sayfasına yönlendirilmek ister misiniz?')) {
                                window.location.href = '/Account/Login';
                            }
                        } else {
                            alert('Ürün sepete eklenirken bir hata oluştu: ' + error);
                        }
                    }
                });
            });
        });
    </script>
}